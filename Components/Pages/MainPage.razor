@page "/"
@inject AppState State
@inject IJSRuntime JSRuntime

<div class="nuclear-viewport">
    
    <div class="header-bar">
        <h1 class="header-title">Gauss System Solver</h1>
        
        <div class="header-stats">
            System Size: <span style="color: #E8E2D8;">@State.Equations.Count</span>
        </div>
        
        <div class="header-actions">
            <button class="btn-reset tooltip-left" 
                    @onclick="ResetSystem" 
                    data-tooltip="Clear all coefficient inputs without deleting equations.">
                Reset
            </button>
        </div>
    </div>

    <div class="scroll-container" @ref="_viewportRef">
        <div class="data-grid">
            @foreach (var eq in State.Equations)
            {
                <div class="grid-row" @key="eq.GetHashCode()">
                    
                    <div class="cell equation">
                        <EquationRow Equation="eq" OnChanged="StateHasChanged" />
                    </div>

                    <div class="cell actions">
                        <button class="btn-delete" @onclick="() => RemoveEquation(eq)" title="Удалить">
                            ✕
                        </button>
                    </div>
                </div>
            }
        </div>
    </div>

    <div class="footer-bar">
        <button class="fab-add" @onclick="AddEquation">+</button>

        <div class="solve-wrapper">
            <SolutionComponent State="State"/>
        </div>
    </div>

</div>

@code {
    private ElementReference _viewportRef;

    private async Task AddEquation()
    {
        State.AddEquation();
        // Автоскролл вниз
        await Task.Delay(50); 
        await JSRuntime.InvokeVoidAsync("scrollToBottom", _viewportRef);
    }
    
    private void RemoveEquation(EquationState eq) => State.RemoveEquation(eq);

    private void ResetSystem() => State.Reset();
}